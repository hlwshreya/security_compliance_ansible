- name: oscap-ssh with KeyStore SUDO_PASSWORD
  shell: |
    oscap-ssh 
    {% if use_sudo %}--sudo {% endif %}
    {{ ansible_user }}@{{ inventory_hostname }} {{ ansible_port | default(22) }} \
      {{ oscap_ssh_args | default('-o StrictHostKeyChecking=no') }} \
      xccdf eval \
      --fetch-remote-resources \
      --profile {{ profile_id }} \
      --results-arf /tmp/{{ inventory_hostname }}-arf.xml \
      --report /tmp/{{ inventory_hostname }}-report.html \
      {{ scap_ds_file }}
  environment:
    SUDO_PASSWORD: "{{ lookup('env', 'SUDO_PASSWORD') | default('') }}"
    SUDO_ASKPASS: /bin/echo
  no_log: "{{ use_sudo | default(false) }}"  # Hide sensitive output
  register: scan_result
  failed_when: scan_result.rc not in [0, 2]
  changed_when: false

- name: Copy datastream to client
  copy:
    src: "{{ scap_ds_file }}"
    dest: /tmp/ssg-ds.xml
    mode: 0644

- name: Run oscap DIRECTLY (as root)
  shell: |
    oscap xccdf eval \
      --fetch-remote-resources \
      --profile {{ profile_id }} \
      --results-arf /tmp/{{ inventory_hostname }}-arf.xml \
      --report /tmp/{{ inventory_hostname }}-report.html \
      /tmp/ssg-ds.xml
  become: yes  # Ansible handles sudo
